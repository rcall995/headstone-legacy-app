<link rel="stylesheet" href="/css/memorial-form.css">

<div class="memorial-form-app">
    <form id="memorialForm" novalidate>
        <!-- Wizard Progress -->
        <div class="wizard-progress-container">
            <div class="wizard-progress">
                <div class="wizard-progress-step" data-step="1">
                    <div class="step-number">1</div>
                    <span class="step-label">Person</span>
                </div>
                <div class="wizard-progress-step" data-step="2">
                    <div class="step-number">2</div>
                    <span class="step-label">Story</span>
                </div>
                <div class="wizard-progress-step" data-step="3">
                    <div class="step-number">3</div>
                    <span class="step-label">Photos</span>
                </div>
                <div class="wizard-progress-step" data-step="4">
                    <div class="step-number">4</div>
                    <span class="step-label">Family</span>
                </div>
                <div class="wizard-progress-step" data-step="5">
                    <div class="step-number">5</div>
                    <span class="step-label">Location</span>
                </div>
            </div>
        </div>

        <!-- Step 1: Person (Basic Info) -->
        <div class="wizard-step" data-step="1">
            <!-- Hidden tier field - everyone gets full features -->
            <input type="hidden" name="tier" value="historian">

            <!-- Basic Information -->
            <div class="form-section">
                <h4 class="section-title"><i class="fas fa-user me-2"></i>About This Person</h4>
                <div class="form-grid">
                    <div class="form-group full-width">
                        <label for="memorial-name" class="form-label">Full Name</label>
                        <input type="text" class="form-control" id="memorial-name" placeholder="Enter full name" required>
                    </div>
                    <div class="form-group full-width">
                        <label for="memorial-title" class="form-label">Title or Epitaph</label>
                        <input type="text" class="form-control" id="memorial-title" placeholder="e.g., Loving Father and Husband">
                    </div>
                    <div class="form-group">
                        <label for="memorial-birth-date" class="form-label">Date of Birth</label>
                        <input type="date" class="form-control" id="memorial-birth-date">
                    </div>
                    <div class="form-group">
                        <label for="memorial-death-date" class="form-label">Date of Death</label>
                        <input type="date" class="form-control" id="memorial-death-date">
                    </div>
                </div>
            </div>

        </div>

        <!-- Step 2: Story -->
        <div class="wizard-step" data-step="2">
            <div class="form-section">
                <h4 class="section-title"><i class="fas fa-book-open me-2"></i>Biography / Life Story</h4>
                <p class="section-subtitle">Share their story, memories, and what made them special</p>

                <!-- AI Biography Helper Button -->
                <div class="bio-helper-prompt mb-3">
                    <div class="bio-helper-card" id="open-bio-helper-btn">
                        <div class="bio-helper-icon">
                            <i class="fas fa-magic"></i>
                        </div>
                        <div class="bio-helper-content">
                            <strong>Need help writing?</strong>
                            <p class="mb-0 small text-muted">Answer a few questions and let AI craft a beautiful biography</p>
                        </div>
                        <i class="fas fa-chevron-right bio-helper-arrow"></i>
                    </div>
                </div>

                <textarea id="memorial-story" class="form-control story-textarea" rows="12" placeholder="Write their story here..."></textarea>
            </div>
        </div>

        <!-- Step 3: Media -->
        <div class="wizard-step" data-step="3">
            <div class="form-section">
                <h4 class="section-title"><i class="fas fa-image me-2"></i>Main Photo</h4>
                <p class="section-subtitle">This will be the primary photo displayed on the memorial</p>
                <div class="photo-upload-area">
                    <input type="file" class="form-control" id="main-photo" accept="image/*" capture="environment">
                    <small class="form-text text-muted">Maximum file size: 10MB</small>
                </div>
                <div id="main-photo-preview" class="photo-preview-grid"></div>
            </div>

            <div class="form-section">
                <h4 class="section-title"><i class="fas fa-images me-2"></i>Photo Gallery</h4>
                <p class="section-subtitle">Add additional photos to create a beautiful gallery</p>
                <div class="photo-upload-area">
                    <input type="file" class="form-control" id="memorial-photos" accept="image/*" capture="environment" multiple>
                    <small class="form-text text-muted">Maximum 20 photos, 10MB each</small>
                </div>
                <div id="photos-preview" class="photo-preview-grid"></div>
            </div>
        </div>

        <!-- Step 4: Family -->
        <div class="wizard-step" data-step="4">
            <div class="form-section">
                <h4 class="section-title"><i class="fas fa-users me-2"></i>Family Connections</h4>
                <p class="section-subtitle">Link family members to build a connected family tree</p>
                <div id="relatives-container" class="dynamic-fields-container"></div>
                <button type="button" class="add-field-btn" id="add-relative-button">
                    <i class="fas fa-plus"></i>
                    Add Family Member
                </button>
            </div>

            <!-- Collaborators Section (only shows when editing) -->
            <div class="form-section" id="collaborators-section" style="display: none;">
                <h4 class="section-title"><i class="fas fa-user-friends me-2"></i>Invite Family to Contribute</h4>
                <p class="section-subtitle">Let family members add photos, stories, and memories</p>

                <!-- Invite Form -->
                <div class="collaborator-invite-form mb-4">
                    <div class="row g-2 align-items-end">
                        <div class="col-md-5">
                            <label class="form-label">Email Address</label>
                            <input type="email" class="form-control" id="invite-email" placeholder="family@example.com">
                        </div>
                        <div class="col-md-4">
                            <label class="form-label">Role</label>
                            <select class="form-select" id="invite-role">
                                <option value="contributor">Contributor - Can add photos & stories</option>
                                <option value="editor">Editor - Can edit memorial details</option>
                                <option value="viewer">Viewer - Read-only access</option>
                            </select>
                        </div>
                        <div class="col-md-3">
                            <button type="button" class="btn btn-primary w-100" id="send-invite-btn">
                                <i class="fas fa-paper-plane me-1"></i>Send Invite
                            </button>
                        </div>
                    </div>
                </div>

                <!-- Collaborators List -->
                <div id="collaborators-list">
                    <div id="collaborators-loading" class="text-center py-4">
                        <div class="spinner-border spinner-border-sm text-primary"></div>
                        <span class="ms-2 text-muted">Loading collaborators...</span>
                    </div>
                    <div id="collaborators-empty" class="text-center py-4" style="display: none;">
                        <i class="fas fa-user-plus fa-2x text-muted mb-2"></i>
                        <p class="text-muted mb-0">No collaborators yet. Invite family members above!</p>
                    </div>
                    <div id="collaborators-container"></div>
                </div>
            </div>
        </div>

        <!-- Step 5: Location -->
        <div class="wizard-step" data-step="5">
            <!-- Cemetery Location -->
            <div class="form-section">
                <h4 class="section-title"><i class="fas fa-map-marker-alt me-2"></i>Cemetery Location</h4>
                <p class="section-subtitle">Where is this person laid to rest? (Optional - you can add this later)</p>
                <div class="form-grid">
                    <div class="form-group">
                        <label for="memorial-cemetery-name" class="form-label">Cemetery Name</label>
                        <input type="text" class="form-control" id="memorial-cemetery-name" placeholder="Enter cemetery name">
                    </div>
                    <div class="form-group">
                        <label for="memorial-cemetery-address" class="form-label">Cemetery Address</label>
                        <div class="input-group">
                            <input type="text" class="form-control" id="memorial-cemetery-address" placeholder="Full address including city, state">
                            <button class="btn btn-outline-primary" type="button" id="use-my-location-btn" title="Use current GPS location">
                                <i class="fas fa-crosshairs"></i>
                            </button>
                            <button class="btn btn-outline-secondary" type="button" id="geocode-cemetery-btn">
                                <i class="fas fa-map-marker-alt"></i>
                            </button>
                        </div>
                        <small class="text-muted" id="geocode-status"></small>
                    </div>
                </div>
                <div id="cemetery-map-preview" class="map-preview"></div>

                <!-- Gravesite Pin Section -->
                <div class="gravesite-pin-section mt-4" id="gravesite-pin-section">
                    <h5 class="section-subtitle"><i class="fas fa-map-pin me-2 text-danger"></i>Exact Gravesite Location <span class="badge bg-secondary ms-2">Optional</span></h5>
                    <p class="text-muted small">Pin the exact location of the grave to help visitors find it within the cemetery.</p>

                    <div class="gravesite-status-card" id="gravesite-status-card">
                        <div id="gravesite-not-set" class="gravesite-status">
                            <i class="fas fa-map-marker-alt text-muted fa-2x mb-2"></i>
                            <p class="mb-2">No gravesite pin set</p>
                            <div class="d-flex gap-2 justify-content-center flex-wrap">
                                <button type="button" class="btn btn-primary" id="set-gravesite-gps-btn">
                                    <i class="fas fa-crosshairs me-2"></i>Use My GPS
                                </button>
                                <button type="button" class="btn btn-outline-secondary" id="set-gravesite-map-btn">
                                    <i class="fas fa-hand-pointer me-2"></i>Pick on Map
                                </button>
                            </div>
                        </div>
                        <div id="gravesite-is-set" class="gravesite-status" style="display: none;">
                            <i class="fas fa-check-circle text-success fa-2x mb-2"></i>
                            <p class="mb-1 fw-bold text-success">Gravesite pinned!</p>
                            <p class="small text-muted mb-2" id="gravesite-coords"></p>
                            <div class="d-flex gap-2 justify-content-center">
                                <button type="button" class="btn btn-sm btn-outline-primary" id="update-gravesite-btn">
                                    <i class="fas fa-sync-alt me-1"></i>Update
                                </button>
                                <button type="button" class="btn btn-sm btn-outline-danger" id="remove-gravesite-btn">
                                    <i class="fas fa-times me-1"></i>Remove
                                </button>
                            </div>
                        </div>
                    </div>

                    <!-- Hidden inputs for gravesite coordinates -->
                    <input type="hidden" id="gravesite-lat" name="gravesite_lat">
                    <input type="hidden" id="gravesite-lng" name="gravesite_lng">
                    <input type="hidden" id="gravesite-accuracy" name="gravesite_accuracy">
                </div>
            </div>

            <!-- Life Journey / Residences -->
            <div class="form-section">
                <h4 class="section-title"><i class="fas fa-route me-2"></i>Life Journey</h4>
                <p class="section-subtitle">Add places they lived to create a map of their life's journey</p>
                <div id="residences-container" class="dynamic-fields-container"></div>
                <button type="button" class="add-field-btn" id="add-residence-button">
                    <i class="fas fa-plus"></i>
                    Add Residence
                </button>
                <div id="life-path-map" class="life-path-map"></div>
            </div>

            <!-- Milestones -->
            <div class="form-section">
                <h4 class="section-title"><i class="fas fa-star me-2"></i>Life Milestones</h4>
                <p class="section-subtitle">Document important events and achievements</p>
                <div id="milestones-container" class="dynamic-fields-container"></div>
                <button type="button" class="add-field-btn" id="add-milestone-button">
                    <i class="fas fa-plus"></i>
                    Add Milestone
                </button>
            </div>
        </div>

        <!-- Bottom Navigation Bar -->
        <div class="wizard-nav-bar">
            <button type="button" class="nav-btn secondary" id="prev-step-btn">
                <i class="fas fa-chevron-left"></i>
                <span>Previous</span>
            </button>
            <div class="nav-center-btns">
                <button type="button" class="nav-btn outline" id="save-draft-button">
                    <i class="fas fa-save"></i>
                    <span>Save Draft</span>
                </button>
                <button type="button" class="nav-btn primary publish" id="publish-button">
                    <i class="fas fa-check-circle"></i>
                    <span>Publish</span>
                </button>
            </div>
            <button type="button" class="nav-btn primary" id="next-step-btn">
                <span>Next</span>
                <i class="fas fa-chevron-right"></i>
            </button>
        </div>
    </form>
</div>

<!-- Success Modal -->
<div class="modal fade" id="successModal" tabindex="-1" aria-labelledby="successModalLabel" aria-hidden="true" data-bs-backdrop="static" data-bs-keyboard="false">
    <div class="modal-dialog modal-dialog-centered modal-lg">
        <div class="modal-content border-0 shadow-lg">
            <div class="modal-body p-0">
                <div class="text-center p-5" style="background: linear-gradient(135deg, var(--primary-color) 0%, var(--secondary-color) 100%);">
                    <div class="mb-4">
                        <i class="fas fa-check-circle text-white" style="font-size: 4rem;"></i>
                    </div>
                    <h2 class="text-white fw-bold mb-3">Memorial Published!</h2>
                    <p class="text-white lead mb-0" id="success-memorial-name">Memorial created successfully</p>
                </div>

                <div class="p-5">
                    <h5 class="fw-bold mb-4">What's Next?</h5>

                    <div class="d-grid mb-4">
                        <a href="#" class="btn btn-primary btn-lg shadow-sm" id="view-memorial-btn">
                            <i class="fas fa-eye me-2"></i>View Your Memorial
                        </a>
                    </div>

                    <div class="card border-0 bg-light mb-3">
                        <div class="card-body">
                            <h6 class="fw-bold mb-2"><i class="fas fa-share-alt text-primary me-2"></i>Share with Family</h6>
                            <p class="text-muted small mb-3">Let your family know about this beautiful memorial</p>
                            <div class="d-flex flex-wrap gap-2">
                                <button class="btn btn-sm btn-outline-primary" id="copy-link-btn">
                                    <i class="fas fa-link me-1"></i>Copy Link
                                </button>
                                <a href="#" class="btn btn-sm btn-outline-success" id="share-whatsapp-btn" target="_blank">
                                    <i class="fab fa-whatsapp me-1"></i>WhatsApp
                                </a>
                                <a href="#" class="btn btn-sm btn-outline-primary" id="share-email-btn">
                                    <i class="fas fa-envelope me-1"></i>Email
                                </a>
                            </div>
                        </div>
                    </div>

                    <div class="card border-primary mb-3">
                        <div class="card-body">
                            <div class="d-flex align-items-start">
                                <div class="flex-shrink-0 me-3">
                                    <i class="fas fa-qrcode text-primary" style="font-size: 2rem;"></i>
                                </div>
                                <div class="flex-grow-1">
                                    <h6 class="fw-bold mb-2">Add a QR Code to the Headstone</h6>
                                    <p class="text-muted small mb-3">Visitors can scan and discover the full story. Weatherproof tag, lifetime guarantee.</p>
                                    <a href="#" class="btn btn-primary btn-sm" id="order-tag-from-success-btn">
                                        <i class="fas fa-tag me-1"></i>Order Tag - $39
                                    </a>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="text-center mt-4">
                        <a href="/memorial-list?status=published" class="text-muted text-decoration-none" data-route data-bs-dismiss="modal">
                            <i class="fas fa-arrow-left me-1"></i>Back to My Memorials
                        </a>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Biography Helper Modal -->
<div class="modal fade" id="bioHelperModal" tabindex="-1" aria-labelledby="bioHelperModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg modal-dialog-centered modal-dialog-scrollable">
        <div class="modal-content">
            <div class="modal-header border-0 pb-0">
                <div>
                    <h5 class="modal-title" id="bioHelperModalLabel">
                        <i class="fas fa-magic text-primary me-2"></i>Biography Helper
                    </h5>
                    <p class="text-muted small mb-0">Answer a few questions to generate a heartfelt biography</p>
                </div>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <!-- Progress indicator -->
                <div class="bio-helper-progress mb-4">
                    <div class="progress" style="height: 4px;">
                        <div class="progress-bar bg-primary" id="bio-helper-progress-bar" style="width: 0%"></div>
                    </div>
                    <small class="text-muted" id="bio-helper-progress-text">0 of 6 questions answered</small>
                </div>

                <!-- Person's name display -->
                <div class="alert alert-light border mb-4" id="bio-helper-name-display">
                    <strong>Writing biography for:</strong> <span id="bio-helper-person-name">-</span>
                </div>

                <!-- Guided prompts -->
                <div class="bio-helper-prompts">
                    <div class="bio-prompt-card" data-prompt="family">
                        <div class="bio-prompt-header">
                            <i class="fas fa-users text-primary"></i>
                            <span>Who were the important people in their life?</span>
                        </div>
                        <textarea class="form-control bio-prompt-input" id="bio-prompt-family" rows="2" placeholder="e.g., Married to Jane for 45 years, father of three children (Mike, Sarah, Tom), grandfather of 7..."></textarea>
                    </div>

                    <div class="bio-prompt-card" data-prompt="career">
                        <div class="bio-prompt-header">
                            <i class="fas fa-briefcase text-warning"></i>
                            <span>What did they do for work?</span>
                        </div>
                        <textarea class="form-control bio-prompt-input" id="bio-prompt-career" rows="2" placeholder="e.g., Worked as a carpenter for 30 years, owned a small bakery, was a dedicated nurse..."></textarea>
                    </div>

                    <div class="bio-prompt-card" data-prompt="earlylife">
                        <div class="bio-prompt-header">
                            <i class="fas fa-graduation-cap text-info"></i>
                            <span>Where did they grow up and go to school?</span>
                        </div>
                        <textarea class="form-control bio-prompt-input" id="bio-prompt-earlylife" rows="2" placeholder="e.g., Born in Chicago, grew up on a farm in Iowa, graduated from Lincoln High School..."></textarea>
                    </div>

                    <div class="bio-prompt-card" data-prompt="hobbies">
                        <div class="bio-prompt-header">
                            <i class="fas fa-heart text-danger"></i>
                            <span>What did they love doing?</span>
                        </div>
                        <textarea class="form-control bio-prompt-input" id="bio-prompt-hobbies" rows="2" placeholder="e.g., Fishing every Sunday, tending the garden, woodworking, cooking for the family..."></textarea>
                    </div>

                    <div class="bio-prompt-card" data-prompt="personality">
                        <div class="bio-prompt-header">
                            <i class="fas fa-smile text-success"></i>
                            <span>How would friends and family describe them?</span>
                        </div>
                        <textarea class="form-control bio-prompt-input" id="bio-prompt-personality" rows="2" placeholder="e.g., Always had a joke ready, generous to a fault, never met a stranger, strong and quiet..."></textarea>
                    </div>

                    <div class="bio-prompt-card" data-prompt="community">
                        <div class="bio-prompt-header">
                            <i class="fas fa-hands-helping text-secondary"></i>
                            <span>Were they involved in church, military, or community?</span>
                        </div>
                        <textarea class="form-control bio-prompt-input" id="bio-prompt-community" rows="2" placeholder="e.g., Deacon at First Baptist, Army veteran (Vietnam), volunteer firefighter, Rotary member..."></textarea>
                    </div>

                    <div class="bio-prompt-card" data-prompt="remember">
                        <div class="bio-prompt-header">
                            <i class="fas fa-star text-warning"></i>
                            <span>What will you miss most about them?</span>
                        </div>
                        <textarea class="form-control bio-prompt-input" id="bio-prompt-remember" rows="2" placeholder="e.g., His Sunday morning pancakes, her warm hugs, the way he could fix anything..."></textarea>
                    </div>
                </div>

                <!-- Generated biography preview -->
                <div class="bio-preview-section mt-4" id="bio-preview-section" style="display: none;">
                    <h6 class="fw-bold mb-2"><i class="fas fa-file-alt me-2"></i>Generated Biography <small class="text-muted fw-normal">(edit as needed)</small></h6>
                    <textarea class="form-control" id="bio-preview-content" rows="8" style="resize: vertical;"></textarea>
                </div>

                <!-- Error display -->
                <div class="alert alert-danger mt-3" id="bio-helper-error" style="display: none;"></div>
            </div>
            <div class="modal-footer border-0 pt-0">
                <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" id="generate-bio-btn">
                    <i class="fas fa-magic me-2"></i>Generate Biography
                </button>
                <button type="button" class="btn btn-success" id="use-bio-btn" style="display: none;">
                    <i class="fas fa-check me-2"></i>Use This Biography
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Memorial Search Modal (for linking family members) -->
<div class="modal fade" id="memorialSearchModal" tabindex="-1" aria-labelledby="memorialSearchModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="memorialSearchModalLabel">
                    <i class="fas fa-link text-primary me-2"></i>Link to Memorial
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <p class="text-muted small">Search for an existing memorial to create a family connection</p>

                <!-- Search input -->
                <div class="input-group mb-3">
                    <span class="input-group-text"><i class="fas fa-search"></i></span>
                    <input type="text" class="form-control" id="memorial-search-input" placeholder="Search by name..." autocomplete="off">
                </div>

                <!-- Search results -->
                <div id="memorial-search-results" class="memorial-search-results">
                    <div class="search-empty-state text-center py-4 text-muted">
                        <i class="fas fa-users fa-2x mb-2 opacity-50"></i>
                        <p class="mb-0">Type a name to search existing memorials</p>
                    </div>
                </div>

                <!-- Currently selected -->
                <div id="memorial-search-selected" class="memorial-search-selected d-none">
                    <label class="form-label small text-muted">Selected Memorial:</label>
                    <div class="selected-memorial-card">
                        <img id="selected-memorial-photo" src="" alt="" class="selected-memorial-photo">
                        <div class="selected-memorial-info">
                            <strong id="selected-memorial-name"></strong>
                            <small id="selected-memorial-dates" class="text-muted d-block"></small>
                        </div>
                        <button type="button" class="btn btn-sm btn-outline-danger" id="clear-memorial-selection">
                            <i class="fas fa-times"></i>
                        </button>
                    </div>
                    <input type="hidden" id="selected-memorial-id">
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" id="confirm-memorial-link-btn" disabled>
                    <i class="fas fa-link me-2"></i>Link Memorial
                </button>
            </div>
        </div>
    </div>
</div>
